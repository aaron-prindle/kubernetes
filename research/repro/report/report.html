<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSA ManagedFields Memory Bottleneck - Analysis Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f6fa;
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 15px;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .summary-box {
            background: #fff;
            border-left: 5px solid #e74c3c;
            padding: 20px 25px;
            margin: 20px 0 30px 0;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-box h2 { margin-top: 0; color: #e74c3c; }
        .summary-box ul { margin: 0; }
        .summary-box li { margin: 8px 0; line-height: 1.5; }
        .chart-section {
            background: #fff;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-section h2 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
        }
        .chart-section img {
            width: 100%;
            max-width: 100%;
            border-radius: 4px;
        }
        .chart-section p {
            color: #555;
            line-height: 1.6;
            margin-top: 15px;
        }
        .env-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .env-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        .env-table td:first-child {
            font-weight: bold;
            width: 200px;
            color: #7f8c8d;
        }
        .highlight { color: #e74c3c; font-weight: bold; }
        .footer {
            text-align: center;
            color: #95a5a6;
            margin-top: 40px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>SSA ManagedFields Memory Bottleneck</h1>
    <p class="subtitle">Analysis Report &mdash; Local Reproduction with Kubernetes v1.35.0</p>

    <div class="summary-box">
        <h2>Key Findings</h2>
        <ul>
            <li><span class="highlight">49.1%</span> of JSON object size is managedFields (2,000 ConfigMaps, 5 managers)</li>
            <li><span class="highlight">62.1%</span> of YAML output lines are managedFields (single object)</li>
            <li><span class="highlight">+63 MB</span> heap increase (+76%) from 2,000 SSA objects</li>
            <li>Projected <span class="highlight">~600 MB - 1.2 GB</span> wasted at 100K objects (5-10 managers)</li>
            <li>Consistent with KEP-555 ("up to 60%") and Issue #102259 (59.72% of memory)</li>
            <li><span class="highlight">No server-side solution exists</span> &mdash; all mitigations are client-side</li>
        </ul>
    </div>

    <div class="chart-section">
        <h2>Test Environment</h2>
        <table class="env-table">
            <tr><td>Cluster</td><td>kind v0.31.0 (Kubernetes v1.35.0)</td></tr>
            <tr><td>Runtime</td><td>Colima + Docker 29.2.0</td></tr>
            <tr><td>Objects Created</td><td>2,000 ConfigMaps via Server-Side Apply</td></tr>
            <tr><td>Managers per Object</td><td>5 (each managing 10 unique keys)</td></tr>
            <tr><td>Total API Calls</td><td>10,000 SSA apply operations</td></tr>
        </table>
    </div>

    <div class="chart-section">
        <h2>Object Size Breakdown</h2>
        <img src="01_object_size_breakdown.png" alt="Object Size Breakdown">
        <p>managedFields constitute <b>49.1% of total JSON object size</b> across 2,000 ConfigMaps with 5 SSA field managers each. For a single object in YAML format, managedFields account for <b>62.1% of all lines</b>.</p>
    </div>

    <div class="chart-section">
        <h2>API Server Memory: Before vs After</h2>
        <img src="02_memory_comparison.png" alt="API Server Memory: Before vs After">
        <p>After loading 2,000 SSA-managed ConfigMaps, apiserver heap grew from <b>83.15 MB to 146.52 MB (+76%)</b> and container RSS from <b>481 MB to 678 MB (+41%)</b>.</p>
    </div>

    <div class="chart-section">
        <h2>Heap Allocation Breakdown</h2>
        <img src="03_heap_allocation_breakdown.png" alt="Heap Allocation Breakdown">
        <p>The top heap allocators post-load show managedFields-related functions (red) consuming <b>~12 MB flat / ~25 MB cumulative</b> of the 63 MB heap increase. FieldsV1.Unmarshal alone accounts for 5 MB.</p>
    </div>

    <div class="chart-section">
        <h2>Watch Cache Decode Chain</h2>
        <img src="04_cumulative_call_chain.png" alt="Watch Cache Decode Chain">
        <p>Objects flow from etcd through protobuf decoding into the watch cache. The cumulative allocation chain shows <b>37 MB</b> flowing through the decode path, with managedFields accounting for a significant portion at each stage.</p>
    </div>

    <div class="chart-section">
        <h2>Scaling Projections</h2>
        <img src="05_scaling_projections.png" alt="Scaling Projections">
        <p>Extrapolating from measured data: at <b>100,000 objects with 5 managers</b>, managedFields would consume <b>~600 MB</b> of heap. With 10 managers, this grows to <b>~1.2 GB</b>. The red shaded area shows memory that could be reclaimed by eliminating managedFields from cache.</p>
    </div>

    <div class="chart-section">
        <h2>Proposed Solutions Impact</h2>
        <img src="06_solution_impact.png" alt="Proposed Solutions Impact">
        <p>Six proposed solutions range from low-risk compression (10-25% savings) to high-impact cache separation (20-40% savings). Combining Phases 1-3 yields an estimated <b>30-50% total memory reduction</b>.</p>
    </div>

    <div class="chart-section">
        <h2>Object Memory Copies</h2>
        <img src="07_memory_copies_diagram.png" alt="Object Memory Copies">
        <p>Each object is stored in <b>4-7 copies</b> within the apiserver, and every copy includes the full managedFields data. At 100K objects, this means <b>2.4 GB of memory</b> is occupied by managedFields that <5% of clients ever read.</p>
    </div>

    <div class="chart-section">
        <h2>Cross-Source Evidence</h2>
        <img src="08_evidence_summary.png" alt="Cross-Source Evidence">
        <p>Seven independent sources consistently show managedFields consuming <b>49-62%</b> of object size or memory. Our local reproduction confirms the findings from KEP-555, GitHub issues, and third-party benchmarks.</p>
    </div>

    <div class="chart-section">
        <h2>Conclusion &amp; Recommended Next Steps</h2>
        <p>This local reproduction confirms that managedFields represent a substantial and
        growing memory overhead in the Kubernetes API server. The data is consistent across
        7 independent sources spanning official KEPs, production profiling, and community benchmarks.</p>
        <p><b>Phase 1 (Lowest Risk):</b> Compress FieldsV1.Raw with zstd in the watch cache.
        Expected 10-25% total memory reduction with minimal CPU overhead and zero API changes.</p>
        <p><b>Phase 2 (Medium Risk):</b> Add <code>showManagedFields=false</code> query parameter
        to allow clients to opt out of receiving managedFields in watch/list responses.</p>
        <p><b>Phase 3 (Highest Impact):</b> Strip managedFields from the watch cache entirely,
        storing them in a compressed sidecar structure. Expected 20-40% total memory reduction.</p>
    </div>

    <p class="footer">
        Generated from local reproduction &mdash; kind cluster (Kubernetes v1.35.0) &mdash;
        2,000 ConfigMaps &times; 5 SSA managers
    </p>
</body>
</html>